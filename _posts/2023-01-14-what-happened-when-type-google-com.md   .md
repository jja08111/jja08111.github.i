---

title: "브라우저에 google.com을 입력하면 일어나는 일"
date: 2023-01-14 16:20:00 -0400
categories: network
tags:

- newtwork
- http
- tcp
- ip
- routing
- arp
- dns

---

철수가 학교에서 랩톱을 켜고 인터넷을 연결한 후 브라우저에 www.google.com을 입력하면 내부적으로 무슨 일이 일어나는지 탐구해보자.

# DHCP

철수가 네트워크에 처음 랩톱을 연결하면 IP 주소 없이는 아무 것도 할 수 없을 것이다.
따라서 처음으로 운영체제가 취하는 행동은 DHCP 프로토콜을 이용하여 로컬 DHCP 서버로부터 IP 주소를 획득하는 것이다.

그렇게 운영체제는 **DHCP 요청 메시지**를 만들어서 이 메시지를 목적지 포트 67(DHCP 서버)과 출발지 포트 68(DHCP 클라이언트)을 갖는 **UDP 세그먼트**에 넣는다.
이 UDP 세그먼트는 브로드캐스트 IP 목적지 주소(255.255.255.255)와 출발지 IP 주소 0.0.0.0(아직 철수의 랩톱에 IP 주소가 없기 때문)을 갖는 IP 데이터그램에 들어간다.

DHCP 요청 메시지를 포함한 IP 데이터그램은 **이더넷 프레임**에 들어간다. 스위치에 연결된 모든 장치(DHCP 서버도 포함)에 이 프레임이 브로드캐스트 될 수 있도록
이더넷 프레임의 목적지 MAC 주소는 FF:FF:FF:FF:FF:FF로 설정된다. 이 프레임의 출발지 MAC 주소는 랩톱의 MAC 주소인 00:16:O3:23:68:8A가 된다.

DHCP 요청 메시지를 포함한 브로드캐스트 이더넷 프레임은 철수의 랩톱이 처음으로 이더넷 스위치에서 전송한 프레임이다. 스위치는 프레임을 자신의 모든 출력 포트(라우터로 연결된 포트도 포함)로 브로드캐스트한다.

라우터는 MAC 주소 00:22:6B:45:1F:1B인 인터페이스로 DHCP 요청 메시지가 포함된 브로드캐스트 이더넷 프레임을 수신한다.
그리고 라우터는 이더넷 프레임으로부터 IP 데이터그램을 추출한다. 그렇게 UDP로 역다중화되고 UDP 세그먼트로부터 DHCP 요청 메시지가 추출된다. 이제 DHCP 서버는 DHCP 요청 메시지를 갖게 된다.

라우터에서 실행되는 DHCP 서버는 철수의 랩톱에게 주소 68.85.2.101을 할당한다.
그리고 DHCP ACK 메시지를 만들며 이는 UDP 세그먼트에 들어가고 UDP 세그먼트는 IP 데이터그램에 들어가며, IP 데이터그램은 이더넷 프레임에 들어간다.

DHCP ACK 메시지를 포함한 이더넷 프레임은 라우터에 의해서 스위치로 전송된다. 스위치는 철수의 랩톱으로 프레임을 전달한다.

철수의 랩톱은 DHCP ACK를 포함하는 이더넷 프레임을 수신한 후 이더넷 프레임으로부터 IP 데이터그램을 추출하고, IP 데이터그램으로부터 UDP 세그먼트를 추출하며, UDP 세그먼트로부터 DHCP ACK 메시지를 추출한다.
드디어 철수의 랩톱은 IP 주소와 DNS 서버의 IP 주소를 기록한다.

# DNS와 ARP

www.google.com의 IP 주소를 알아야하기 때문에 DNS 프로토콜을 이용해야 한다. 운영체제는 DNS 질의 메시지를 생성하여 질문 부분에 "www.google.com"을 넣는다.
DNS 질의 메시지는 목적지 포트가 53(DNS 서버)인 UDP 세그먼트에 들어간다. UDP 세그먼트는 목적지 IP 주소 68.87.71.226(이전에 DHCP ACK에서 얻은 주소)과 출발지 주소 68.85.2.101인 IP 데이터그램에 들어간다.

운영체제는 DNS 질의 메시지가 포함된 데이텀그램을 이더넷 프레임에 넣는다. 이 프레임은 철수의 학교 네트워크에 있는 게이트웨이 라우터로 보내야한다.
그런데 **게이트웨이 라우터의 MAC 주소를 모르기 때문에 MAC 주소를 얻어야한다.** 이를 위해 ARP 프로토콜을 사용해야한다.

ARP 질의를 브로드캐스트로 전송하고 게이트웨이 라우터는 ARP 질의 메시지를 수신하여 철수의 랩톱에 ARP 응답 메시지를 전송한다.

드디어 철수의 랩톱은 게이트웨이 라우터의 MAC 주소로 DNS 질의 메시지가 포함된 이더넷 프레임을 보낼 수 있다.

# DNS 서버로의 라우팅

게이트웨이 라우터로 DNS 질의 메시지를 보내면 라우팅 프로토콜에 의해 DNS 서버로 전달된다.
DNS 서버는 DNS 질의 메시지를 추출한 후 DNS 데이터베이스에서 www.google.com을 찾아서 이에 해당하는 IP 주소를 포함하는 DNS 자원 레코드를 찾는다.
그렇게 DNS는 DNS 응답 메시지를 만들어서 UDP 세그먼트에 넣은 후 이를 통해 IP 데이터그램을 만들어 전송한다.

마침내! 철수의 랩톱은 www.google.com의 IP 주소를 얻는다. 후... 생략을 많이 했지만 그래도 상당히 많은 일들이 일어났다.

# TCP와 HTTP

이제 철수의 랩톱은 www.google.com의 IP 주소를 갖게 되었으며, **HTTP GET** 메시지를 보내는 데 사용할 **TCP 소켓**을 생성할 수 있다.
TCP 소켓을 생성할 때 철수의 랩톱의 TCP는 www.google.com에 있는 TCP와 3-way handshake를 먼저 수행한다.
연결 설정이 완료되면 철수 랩톱은 소켓으로 HTTP GET 요청를 www.google.com으로 보낸다.

www.google.com은 이 요청 메시지를 읽고, **HTTP 응답** 메시지를 생성하고 요청된 웹 페이지의 콘텐츠를 HTTP 응답 메시지의 body에 포함시켜 TCP 소켓으로 보낸다.

이 데이터그램은 구글, 콤캐스트, 학교 네트워크를 통해 전달되어 철수의 랩톱에 도착한다. 철수의 웹 브라우저 프로그램은 소켓에서 HTTP 응답 메시지를 읽어서,
HTTP 응답 메시지의 바디로부터 웹 페이지에 대한 html을 추출한 후 마침내 웹 페이지를 렌더링한다.

# 참조

컴퓨터 네트워킹 하향식 접근 7판, James F. Kurose - Keith W. Ross, 2018, 퍼스트북
